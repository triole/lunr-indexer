version: '3'

vars:
    ARCHS_TO_BUILD: |
        - armv6l:GOARM=6 GOARCH=arm
        - armv7l:GOARM=7 GOARCH=arm
        - armv8l:GOARCH=arm64
        - i686:GOARCH=386
        - x86_64:GOARCH=amd64

    TARGET_FOLDER: build

    SOURCE_FOLDER:
        sh: find . -regex ".*\.go$" | head -n 1 | grep -Po ".*(?=\/)"

    AUTHOR:
        sh: grep -Po "(?<=name\s=\s).*" ~/.gitconfig

    APP_NAME:
        sh: pwd | tr '/' '\n' | tail -1

    ARCH:
        sh: arch

    DATE:
        sh: date

    GIT_COMMIT_NO:
        sh: git rev-list --all --count

    GIT_COMMIT_HASH:
        sh: git rev-parse HEAD

tasks:
    default:
        cmds:
            - task: buildall

    buildall:
        desc: build all architectures in build list
        cmds:
            - |
                {{range $i, $line := .ARCHS_TO_BUILD | splitLines}}
                    {{if $line}}task build ta={{$line | regexFind ":[0-9a-zA-Z= ]+$" | trimPrefix ":"}} tf={{$line | regexFind "[0-9a-z+]+" }}{{end}}
                {{end}}

    build:
        desc: build binary, also called by buildall
        cmds:
            - cmd: mkdir -p $(pwd)/{{.TARGET_FOLDER}}/{{.tf}}
            - cmd: >-
                CGO_ENABLED=0 {{.ta}}
                go build -o $(pwd)/{{.TARGET_FOLDER}}/{{.tf}}/{{.APP_NAME}}
                -ldflags "-s -w -X 'main.BUILDTAGS={
                _subversion: {{.GIT_COMMIT_NO}}, Author: {{.AUTHOR}},
                Build date: {{.DATE}}, Git hash: {{.GIT_COMMIT_HASH}}
                }'"
                src/*.go
            - cmd: file $(pwd)/{{.TARGET_FOLDER}}/{{.tf}}/{{.APP_NAME}}

    xbuild:
        desc: extended build utilising my personal build script 'bob'
        cmds:
            - cmd: >-
                bob -b V -c
                -f '_subversion: {{.GIT_COMMIT_NO}}, Author: {{.AUTHOR}},
                Build date: {{.DATE}}, Git hash: {{.GIT_COMMIT_HASH}}'
    test:
        cmds:
            - cmd: >-
                go test
                -trace go.trace -race -cover -bench=.
                {{.SOURCE_FOLDER}}/*.go

    deploy:
        cp -rpf build/* ${HOME}/tools/arch/mybins/

    mod:
        desc: update go modules
        cmds:
            - cmd: if [[ ! -f go.mod ]]; then go mod init {{.APP_NAME}}; fi
            - cmd: go mod tidy
